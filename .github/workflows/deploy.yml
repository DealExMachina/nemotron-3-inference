name: üöÄ Deploy to Koyeb

on:
  push:
    branches: [main]
    paths:
      - 'Dockerfile'
      - 'koyeb.yaml'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:
    inputs:
      skip_build:
        description: 'Skip Docker build (redeploy only)'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: docker.io
  IMAGE_NAME: ${{ vars.DOCKERHUB_USER }}/nemotron-3-inference
  # Existing Koyeb service - DO NOT CHANGE
  KOYEB_APP_NAME: nemotron-3-inference
  KOYEB_SERVICE_NAME: nemotron

jobs:
  build-and-push:
    name: üê≥ Build & Push Docker Image
    runs-on: ubuntu-latest
    if: github.event.inputs.skip_build != 'true'
    permissions:
      contents: read

    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      sha-tag: ${{ steps.sha.outputs.tag }}

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üîê Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_KEY }}

      - name: üè∑Ô∏è Compute SHA tag
        id: sha
        run: |
          SHA_TAG=sha-${GITHUB_SHA::7}
          echo "tag=$SHA_TAG" >> $GITHUB_OUTPUT
          echo "üìå SHA tag: $SHA_TAG"

      - name: üè∑Ô∏è Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      - name: üîß Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üßπ Clean up disk space
        run: |
          docker system prune -f
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          df -h

      - name: üèóÔ∏è Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

  deploy-koyeb:
    name: üöÄ Deploy to Koyeb
    needs: build-and-push
    runs-on: ubuntu-latest
    if: |
      always() &&
      github.ref == 'refs/heads/main' &&
      (needs.build-and-push.result == 'success' || needs.build-and-push.result == 'skipped')
    environment:
      name: production
      url: https://nemotron-3-inference-dealexmachina-53d19e1c.koyeb.app

    steps:
      - name: üîß Install Koyeb CLI and Deploy
        env:
          KOYEB_TOKEN: ${{ secrets.KOYEB_API_TOKEN }}
        run: |
          # Install Koyeb CLI with retries
          echo "üì¶ Installing Koyeb CLI..."
          for i in 1 2 3; do
            echo "Attempt $i/3..."
            if curl -fsSL --retry 3 --retry-delay 5 https://get.koyeb.com | sh; then
              echo "‚úÖ CLI installed successfully"
              break
            fi
            echo "‚ö†Ô∏è Attempt $i failed, retrying in 10s..."
            sleep 10
          done
          
          # Add to PATH
          export PATH="$HOME/.koyeb/bin:$PATH"
          
          # Verify installation
          if ! command -v koyeb &> /dev/null; then
            echo "‚ùå Koyeb CLI not found, trying direct download..."
            mkdir -p "$HOME/.koyeb/bin"
            curl -fsSL --retry 3 -o "$HOME/.koyeb/bin/koyeb" \
              "https://github.com/koyeb/koyeb-cli/releases/latest/download/koyeb_linux_amd64"
            chmod +x "$HOME/.koyeb/bin/koyeb"
          fi
          
          # Authenticate
          koyeb login --token "$KOYEB_TOKEN"
          
          # Set variables
          APP_NAME="${{ env.KOYEB_APP_NAME }}"
          SVC_NAME="${{ env.KOYEB_SERVICE_NAME }}"
          
          if [ "${{ github.event.inputs.skip_build }}" = "true" ]; then
            IMAGE="${{ env.IMAGE_NAME }}:latest"
          else
            IMAGE="${{ env.IMAGE_NAME }}:${{ needs.build-and-push.outputs.sha-tag }}"
          fi
          
          echo "üì¶ Deploying image: $IMAGE"
          echo "üìç App: $APP_NAME / Service: $SVC_NAME"
          
          # Update existing service with new image
          echo "üöÄ Updating service..."
          koyeb service update $SVC_NAME --app $APP_NAME \
            --docker-image "$IMAGE"
          
          echo "‚úÖ Service update triggered!"
          echo "üîó URL: https://nemotron-3-inference-dealexmachina-53d19e1c.koyeb.app"

      - name: ‚è≥ Wait for deployment
        run: |
          echo "‚è≥ Waiting for deployment to stabilize..."
          sleep 60

      - name: üè• Health check
        run: |
          echo "üè• Checking deployment health..."
          
          SERVICE_URL="https://nemotron-3-inference-dealexmachina-53d19e1c.koyeb.app"
          
          for i in {1..5}; do
            echo "üîç Health check attempt $i/5..."
            
            response=$(curl -s -w "%{http_code}" -o /dev/null "$SERVICE_URL/health" --max-time 30 || echo "000")
            
            if [ "$response" = "200" ]; then
              echo "‚úÖ Deployment is healthy!"
              break
            else
              echo "‚è≥ Status: $response, retrying in 60s..."
              sleep 60
            fi
          done
          
          if [ "$response" != "200" ]; then
            echo "‚ö†Ô∏è Health check did not pass, but deployment may still be starting up."
          fi
          
          echo "üîó Service URL: $SERVICE_URL"

      - name: üìù Create Deployment Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## üöÄ Deployment Summary
          
          ### ‚úÖ Deployment Triggered
          - **App**: \`${{ env.KOYEB_APP_NAME }}\`
          - **Service**: \`${{ env.KOYEB_SERVICE_NAME }}\`
          - **Instance**: GPU NVIDIA H100
          - **Region**: North America
          
          ### üîó URLs
          - **Service**: [https://nemotron-3-inference-dealexmachina-53d19e1c.koyeb.app](https://nemotron-3-inference-dealexmachina-53d19e1c.koyeb.app)
          
          ### üì¶ Build Details
          - **Skip Build**: ${{ github.event.inputs.skip_build == 'true' && 'Yes' || 'No' }}
          EOF

  # Standalone redeploy job - only runs on manual trigger with skip_build=true
  redeploy-only:
    name: üîÑ Redeploy (no build)
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' && 
      github.event.inputs.skip_build == 'true'
    environment:
      name: production
      url: https://nemotron-3-inference-dealexmachina-53d19e1c.koyeb.app

    steps:
      - name: üîß Install Koyeb CLI and Redeploy
        env:
          KOYEB_TOKEN: ${{ secrets.KOYEB_API_TOKEN }}
        run: |
          # Install Koyeb CLI with retries
          echo "üì¶ Installing Koyeb CLI..."
          for i in 1 2 3; do
            echo "Attempt $i/3..."
            if curl -fsSL --retry 3 --retry-delay 5 https://get.koyeb.com | sh; then
              echo "‚úÖ CLI installed successfully"
              break
            fi
            echo "‚ö†Ô∏è Attempt $i failed, retrying in 10s..."
            sleep 10
          done
          
          # Add to PATH
          export PATH="$HOME/.koyeb/bin:$PATH"
          
          # Verify installation
          if ! command -v koyeb &> /dev/null; then
            echo "‚ùå Koyeb CLI not found, trying direct download..."
            mkdir -p "$HOME/.koyeb/bin"
            curl -fsSL --retry 3 -o "$HOME/.koyeb/bin/koyeb" \
              "https://github.com/koyeb/koyeb-cli/releases/latest/download/koyeb_linux_amd64"
            chmod +x "$HOME/.koyeb/bin/koyeb"
          fi
          
          # Authenticate
          koyeb login --token "$KOYEB_TOKEN"
          
          # Set variables
          APP_NAME="${{ env.KOYEB_APP_NAME }}"
          SVC_NAME="${{ env.KOYEB_SERVICE_NAME }}"
          IMAGE="${{ env.IMAGE_NAME }}:latest"
          
          echo "üì¶ Redeploying with image: $IMAGE"
          
          koyeb service update $SVC_NAME --app $APP_NAME \
            --docker-image "$IMAGE"
          
          echo "‚úÖ Redeployment triggered!"
          echo "üîó URL: https://nemotron-3-inference-dealexmachina-53d19e1c.koyeb.app"
