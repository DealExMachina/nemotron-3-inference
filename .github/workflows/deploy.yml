name: Build and Deploy to Koyeb

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  REGISTRY: docker.io
  IMAGE_NAME: ${{ vars.DOCKERHUB_USER }}/nemotron-3-inference

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
      image_digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_KEY }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy-to-koyeb:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Koyeb CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/koyeb/koyeb-cli/master/install.sh | bash
          echo "$HOME/.koyeb/bin" >> $GITHUB_PATH

      - name: Deploy to Koyeb
        run: |
          # Get token from secrets (matches .env variable name KOYEB_API_TOKEN)
          KOYEB_API_TOKEN="${{ secrets.KOYEB_API_TOKEN }}"
          
          # Verify token is set
          if [ -z "$KOYEB_API_TOKEN" ]; then
            echo "âŒ KOYEB_API_TOKEN secret is not set"
            exit 1
          fi
          
          # Remove single quotes, double quotes, and all whitespace
          CLEAN_TOKEN=$(echo "$KOYEB_API_TOKEN" | sed "s/^['\"]//; s/['\"]$//" | tr -d '\r\n\t ' | xargs)
          
          # Verify token is not empty after cleaning
          if [ -z "$CLEAN_TOKEN" ]; then
            echo "âŒ Token is empty after cleaning"
            exit 1
          fi
          
          # Export as KOYEB_TOKEN (Koyeb CLI expects this exact name)
          export KOYEB_TOKEN="$CLEAN_TOKEN"
          
          echo "ðŸ” Using Koyeb API token (CLI reads KOYEB_TOKEN from environment)"
          
          # Use the explicit image name with latest tag
          # Try without docker.io prefix first (Koyeb may prefer this format)
          DOCKER_IMAGE="${{ env.IMAGE_NAME }}:latest"
          echo "ðŸ“¦ Using Docker image: $DOCKER_IMAGE"
          
          # Verify image exists on Docker Hub before deploying
          echo "ðŸ” Verifying image exists on Docker Hub..."
          IMAGE_USER=$(echo "$DOCKER_IMAGE" | cut -d'/' -f1)
          IMAGE_REPO=$(echo "$DOCKER_IMAGE" | cut -d'/' -f2 | cut -d':' -f1)
          IMAGE_TAG=$(echo "$DOCKER_IMAGE" | cut -d':' -f2)
          
          # Check if image exists via Docker Hub API
          if curl -s -f "https://hub.docker.com/v2/repositories/${IMAGE_USER}/${IMAGE_REPO}/tags/${IMAGE_TAG}" > /dev/null; then
            echo "âœ… Image verified on Docker Hub: $DOCKER_IMAGE"
          else
            echo "âš ï¸  Could not verify image via API, but continuing anyway..."
          fi
          
          # Wait a moment for Docker Hub to propagate the image (if just built)
          echo "â³ Waiting 20 seconds for Docker Hub image propagation..."
          sleep 20
          
          # Check if app exists, create if not
          echo "ðŸ“¦ Checking for app nemotron-3-inference..."
          if koyeb app get nemotron-3-inference > /dev/null 2>&1; then
            echo "âœ“ App exists"
          else
            echo "ðŸ“ Creating app nemotron-3-inference..."
            koyeb app create nemotron-3-inference || {
              echo "âŒ Failed to create app"
              exit 1
            }
          fi

          # Deploy using koyeb.yaml file (might handle image validation better)
          echo "ðŸš€ Deploying service using koyeb.yaml..."
          
          # Update the image in koyeb.yaml temporarily
          sed -i.bak "s|image:.*|image: $DOCKER_IMAGE|" koyeb.yaml
          
          # Deploy using the YAML file
          if koyeb service get nemotron-3-inference/nemotron > /dev/null 2>&1; then
            echo "ðŸ“ Updating existing service from koyeb.yaml..."
            koyeb service update nemotron-3-inference/nemotron -f koyeb.yaml || {
              echo "âš ï¸  YAML update failed, trying CLI method..."
              koyeb service update nemotron-3-inference/nemotron \
                --docker "$DOCKER_IMAGE" \
                --instance-type gpu-nvidia-a100 \
                --regions fra \
                --ports 8000:http \
                --routes /:8000 \
                --checks 8000:http:/health \
                --env "HF_TOKEN=@hf-token" \
                --env "VLLM_ATTENTION_BACKEND=FLASHINFER" \
                --min-scale 0 \
                --max-scale 1
            }
          else
            echo "ðŸ“ Creating new service from koyeb.yaml..."
            koyeb service create -f koyeb.yaml || {
              echo "âš ï¸  YAML create failed, trying CLI method..."
              koyeb service create nemotron \
                --app nemotron-3-inference \
                --docker "$DOCKER_IMAGE" \
                --instance-type gpu-nvidia-a100 \
                --regions fra \
                --ports 8000:http \
                --routes /:8000 \
                --checks 8000:http:/health \
                --env "HF_TOKEN=@hf-token" \
                --env "VLLM_ATTENTION_BACKEND=FLASHINFER" \
                --min-scale 0 \
                --max-scale 1
            }
          fi
          
          # Restore original koyeb.yaml
          mv koyeb.yaml.bak koyeb.yaml 2>/dev/null || true
          
          echo "âœ… Deployment complete!"

